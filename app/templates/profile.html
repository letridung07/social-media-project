{# app/templates/profile.html #}
{% extends "base.html" %}
{% block title %}{{ user.username }}'s Profile{% endblock %} {# This title block is important #}

{% block content %} {# Adjusted from app_content to content #}
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <img src="{{ url_for('static', filename='images/' + user.profile_picture_url) }}" alt="{{ user.username }}'s profile picture" class="img-fluid rounded-circle mb-3" style="width: 150px; height: 150px;">
                    <h2 class="card-title mt-2">{{ user.username }}</h2>
                    {% if user.bio %}
                        <p class="card-text text-muted mb-3">{{ user.bio }}</p>
                    {% endif %}
                    {% if user == current_user %}
                        <a href="{{ url_for('main.edit_profile') }}" class="btn btn-secondary btn-sm mb-2">Edit Profile</a>
                    {% elif current_user.is_authenticated %} {# Ensure current_user is authenticated before checking is_following #}
                        {% if current_user.is_following(user) %}
                            <form action="{{ url_for('main.unfollow', username=user.username) }}" method="post" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}"/>
                                <input type="submit" value="Unfollow" class="btn btn-danger btn-sm mb-2">
                            </form>
                        {% else %}
                            <form action="{{ url_for('main.follow', username=user.username) }}" method="post" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}"/>
                                <input type="submit" value="Follow" class="btn btn-primary btn-sm mb-2">
                            </form>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <h3 class="mt-3 mt-md-0">{{ user.username }}'s Posts:</h3>
            {% if posts %}
                {% for post in posts %}
                    {% include '_post.html' %} {# This includes the _post.html partial #}
                {% endfor %}
            {% else %}
                <div class="alert alert-secondary mt-3" role="alert">
                    {{ user.username }} has not posted anything yet.
                </div>
            {% endif %}

            <hr class="my-4"> {# Visual separator #}

            <h3 class="mt-3">Groups {{ user.username }} is a member of:</h3>
            {% if user.group_memberships and user.group_memberships.count() > 0 %}
                <div class="list-group">
                    {% for membership in user.group_memberships %}
                        <a href="{{ url_for('main.view_group', group_id=membership.group.id) }}" class="list-group-item list-group-item-action">
                            {{ membership.group.name }}
                            {% if membership.role == 'admin' %}<span class="badge bg-info float-right mt-1">Admin</span>{% endif %}
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p>{{ user.username }} is not a member of any groups yet.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

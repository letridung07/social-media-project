{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>

    <form method="GET" action="{{ url_for('main.search') }}" class="mb-4 needs-validation" novalidate>
        <div class="row">
            <div class="col-md-5 mb-2">
                <label for="searchQuery" class="sr-only">Search Term</label>
                <input type="text" name="q" id="searchQuery" class="form-control" placeholder="Enter search term..." value="{{ query or '' }}" required>
                <div class="invalid-feedback">
                    Please enter a search term.
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <label for="searchCategory" class="sr-only">Category</label>
                <select name="category" id="searchCategory" class="form-control custom-select">
                    <option value="all" {% if selected_category == 'all' %}selected{% endif %}>All Categories</option>
                    <option value="users" {% if selected_category == 'users' %}selected{% endif %}>Users</option>
                    <option value="posts" {% if selected_category == 'posts' %}selected{% endif %}>Posts</option>
                    <option value="groups" {% if selected_category == 'groups' %}selected{% endif %}>Groups</option>
                    <option value="hashtags" {% if selected_category == 'hashtags' %}selected{% endif %}>Hashtags</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label for="searchSortBy" class="sr-only">Sort By</label>
                <select name="sort_by" id="searchSortBy" class="form-control custom-select">
                    <option value="relevance" {% if selected_sort_by == 'relevance' %}selected{% endif %}>Relevance</option>
                    <option value="date" {% if selected_sort_by == 'date' %}selected{% endif %}>Date</option>
                    <option value="popularity" {% if selected_sort_by == 'popularity' %}selected{% endif %}>Popularity</option>
                </select>
            </div>
            <div class="col-md-1 mb-2">
                <button type="submit" class="btn btn-primary btn-block">Go</button>
            </div>
        </div>
    </form>

    {% if not query and not (users or posts or groups or hashtags) %}
        <p class="text-muted">Enter a term above and click "Go" to search.</p>
    {% endif %}

    {% if users and (selected_category == 'all' or selected_category == 'users') %}
        <h2>Users Found ({{ users|length }})</h2>
        <ul class="list-group mb-3">
            {% for user in users %}
                <li class="list-group-item">
                    <a href="{{ url_for('main.profile', username=user.username) }}">
                        <img src="{{ url_for('static', filename='images/' + user.profile_picture_url) }}" loading="lazy" alt="{{ user.username }}'s profile picture" class="rounded-circle mr-2" width="30" height="30" style="margin-right: 5px;">
                        {{ user.username }}
                    </a>
                    {% if user.bio %}
                        <small class="text-muted d-block mt-1">{{ user.bio[:100] }}{% if user.bio|length > 100 %}...{% endif %}</small>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if posts and (selected_category == 'all' or selected_category == 'posts') %}
        <h2>Posts Found ({{ posts|length }})</h2>
        {% for post in posts %}
            {% set item_wrapper = {'type': 'post', 'item': post, 'timestamp': post.timestamp, 'sharer': None} %}
            {% include "_post.html" %}
        {% endfor %}
    {% endif %}

    {% if groups and (selected_category == 'all' or selected_category == 'groups') %}
        <h2>Groups Found ({{ groups|length }})</h2>
        <ul class="list-group mb-3">
            {% for group in groups %}
                <li class="list-group-item">
                    <a href="{{ url_for('main.view_group', group_id=group.id) }}">
                        <img src="{{ url_for('static', filename='group_images/' + group.image_file) if group.image_file else url_for('static', filename='group_images/default_group_pic.png') }}" loading="lazy" alt="{{ group.name }}'s image" class="rounded-circle mr-2" width="30" height="30" style="margin-right: 5px;">
                        {{ group.name }}
                    </a>
                    {% if group.description %}
                        <small class="text-muted d-block mt-1">{{ group.description[:100] }}{% if group.description|length > 100 %}...{% endif %}</small>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if hashtags and (selected_category == 'all' or selected_category == 'hashtags') %}
        <h2>Hashtags Found ({{ hashtags|length }})</h2>
        <ul class="list-group mb-3">
            {% for hashtag in hashtags %}
                <li class="list-group-item">
                    <a href="{{ url_for('main.hashtag_feed', tag_text=hashtag.tag_text) }}">#{{ hashtag.tag_text }}</a>
                    {# Optionally, display popularity (number of posts) if available from route #}
                    {# Example: <span class="badge badge-secondary float-right">{{ hashtag.post_count }} posts</span> #}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if query and not (users or posts or groups or hashtags) %}
         <p class="mt-4">No results found matching your query "{{ query }}"
            {% if selected_category != 'all' %} in category "{{ selected_category.capitalize() }}"{% endif %}.
        </p>
    {% elif not query and (selected_category != 'all' or selected_sort_by != 'relevance') %}
        {# Case where filters are applied but no query term is entered #}
        <p class="text-muted">Please enter a search term to see results with the selected filters.</p>
    {% endif %}
</div>

<script>
// Example starter JavaScript for disabling form submissions if there are invalid fields
(function() {
  'use strict';
  window.addEventListener('load', function() {
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.getElementsByClassName('needs-validation');
    // Loop over them and prevent submission
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        if (form.elements.q.value.trim() === '') { // Check if query is empty
            event.preventDefault();
            event.stopPropagation();
            form.elements.q.classList.add('is-invalid'); // Show error on query input
            // Optionally focus the input: form.elements.q.focus();
        } else {
            form.elements.q.classList.remove('is-invalid');
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>
{% endblock content %}
